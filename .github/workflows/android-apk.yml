# yaml-language-server: $schema=https://json.schemastore.org/github-workflow.json
# Last CI trigger: 2025-12-19 17:55:06
# yaml-language-server: $schema=https://json.schemastore.org/github-workflow.json

name: Android APK (Flutter)

on:
  push:
    branches: ["main"]
  pull_request:
    branches: ["main"]
  workflow_dispatch:

jobs:
  build-apk:
    runs-on: ubuntu-latest

    env:
      # Ensure the Android SDK env vars are always defined.
      # The runner/"setup-android" step may still override these, but having defaults
      # makes scripts more predictable and avoids "SDK not found" when runner env changes.
      ANDROID_SDK_ROOT: /usr/local/lib/android/sdk
      ANDROID_HOME: /usr/local/lib/android/sdk
      ANDROID_KEYSTORE_BASE64: ${{ secrets.ANDROID_KEYSTORE_BASE64 }}
      ANDROID_KEYSTORE_PASSWORD: ${{ secrets.ANDROID_KEYSTORE_PASSWORD }}
      ANDROID_KEY_PASSWORD: ${{ secrets.ANDROID_KEY_PASSWORD }}
      ANDROID_KEY_ALIAS: ${{ secrets.ANDROID_KEY_ALIAS }}

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Debug runner environment
        shell: bash
        run: |
          echo "=== GitHub Runner Environment ==="
          echo "ANDROID_SDK_ROOT=${ANDROID_SDK_ROOT:-<not set>}"
          echo "ANDROID_HOME=${ANDROID_HOME:-<not set>}"
          echo ""
          echo "=== Checking common SDK locations ==="
          for path in "/usr/local/lib/android/sdk" "/opt/hostedtoolcache/android/sdk" "/opt/android-sdk"; do
            if [ -d "$path" ]; then
              echo "FOUND: $path"
              ls -la "$path" 2>/dev/null | head -5
            else
              echo "NOT FOUND: $path"
            fi
          done
          echo ""
          echo "=== Environment variables containing 'android' (case-insensitive) ==="
          env | grep -i android || echo "(none found)"

      - name: Prepare Gradle wrapper (LF + executable)
        shell: bash
        run: |
          set -euo pipefail
          # In case gradlew was committed with CRLF or lost its +x bit.
          sed -i 's/\r$//' android/gradlew
          chmod +x android/gradlew

      - name: Set up Java
        uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: "17"

      - name: Set up Android SDK
        uses: android-actions/setup-android@v3

      - name: Set Android SDK environment variables
        shell: bash
        run: |
          # The ubuntu-latest runner has Android SDK pre-installed at /usr/local/lib/android/sdk
          # The setup-android action may set ANDROID_HOME to a different location
          # We need to ensure both vars are set correctly
          
          # Check multiple possible SDK locations
          SDK_FOUND=""
          for SDK_PATH in \
            "${ANDROID_HOME:-}" \
            "${ANDROID_SDK_ROOT:-}" \
            "/usr/local/lib/android/sdk" \
            "/opt/hostedtoolcache/android/sdk"; do
            if [ -n "$SDK_PATH" ] && [ -d "$SDK_PATH" ]; then
              SDK_FOUND="$SDK_PATH"
              break
            fi
          done
          
          if [ -z "$SDK_FOUND" ]; then
            echo "ERROR: Could not find Android SDK in any known location" >&2
            echo "Listing /usr/local/lib/android:" >&2
            ls -la /usr/local/lib/android 2>/dev/null || echo "  (directory does not exist)"
            echo "Listing /opt/hostedtoolcache:" >&2
            ls -la /opt/hostedtoolcache 2>/dev/null || echo "  (directory does not exist)"
            exit 1
          fi
          
          echo "ANDROID_SDK_ROOT=$SDK_FOUND" >> $GITHUB_ENV
          echo "ANDROID_HOME=$SDK_FOUND" >> $GITHUB_ENV
          echo "Android SDK found and configured at: $SDK_FOUND"
          echo "SDK contents:"
          ls -la "$SDK_FOUND" || true

      - name: Free up disk space
        shell: bash
        run: |
          echo "=== Disk usage BEFORE cleanup ==="
          df -h
          echo ""
          echo "Removing unnecessary preinstalled software..."
          # Remove large preinstalled packages to free ~20GB+
          # NOTE: Do NOT remove Android SDK core components, only NDK/CMake which are large and optional
          SDK_PATH="${ANDROID_SDK_ROOT:-/usr/local/lib/android/sdk}"
          sudo rm -rf "$SDK_PATH/ndk" || true
          sudo rm -rf "$SDK_PATH/cmake" || true
          sudo rm -rf /usr/share/dotnet || true
          sudo rm -rf /opt/ghc || true
          sudo rm -rf /usr/local/share/boost || true
          sudo rm -rf /usr/local/graalvm || true
          sudo rm -rf /usr/local/share/powershell || true
          sudo rm -rf /usr/local/share/chromium || true
          sudo rm -rf /usr/local/lib/node_modules || true
          sudo apt-get clean || true
          # Clear Gradle and pub caches from previous runs
          rm -rf ~/.gradle/caches/ || true
          rm -rf ~/.pub-cache || true
          echo ""
          echo "=== Disk usage AFTER cleanup ==="
          df -h

      - name: Resolve Android SDK env (best-effort)
        shell: bash
        run: |
          set -euo pipefail
          # Verify the SDK is available at the expected location
          SDK_ROOT="${ANDROID_SDK_ROOT:-${ANDROID_HOME:-}}"
          
          if [ -z "$SDK_ROOT" ] || [ ! -d "$SDK_ROOT" ]; then
            echo "Android SDK not found at expected location." >&2
            echo "ANDROID_SDK_ROOT=${ANDROID_SDK_ROOT:-<unset>}" >&2
            echo "ANDROID_HOME=${ANDROID_HOME:-<unset>}" >&2
            # Try to find SDK in common locations
            for CANDIDATE in \
              "/usr/local/lib/android/sdk" \
              "/opt/hostedtoolcache/android/sdk" \
              "/opt/android-sdk" \
              "/opt/android"; do
              if [ -d "$CANDIDATE" ]; then
                echo "Found SDK at: $CANDIDATE"
                echo "ANDROID_SDK_ROOT=$CANDIDATE" >> "$GITHUB_ENV"
                echo "ANDROID_HOME=$CANDIDATE" >> "$GITHUB_ENV"
                SDK_ROOT="$CANDIDATE"
                break
              fi
            done
          fi

          if [ -z "$SDK_ROOT" ] || [ ! -d "$SDK_ROOT" ]; then
            echo "ERROR: Could not locate Android SDK" >&2
            ls -la /usr/local/lib/android 2>/dev/null || true
            ls -la /opt/hostedtoolcache/android 2>/dev/null || true
            exit 1
          fi

          echo "Verified ANDROID_SDK_ROOT=$SDK_ROOT"
          ls -la "$SDK_ROOT" || true

      - name: Ensure Android SDK platform (API 35)
        shell: bash
        run: |
          set -euo pipefail
          echo "ANDROID_SDK_ROOT=$ANDROID_SDK_ROOT"
          echo "ANDROID_HOME=$ANDROID_HOME"

          if [ ! -d "$ANDROID_SDK_ROOT" ]; then
            echo "ANDROID_SDK_ROOT does not exist at $ANDROID_SDK_ROOT" >&2
            echo "If GitHub runner changes, update the fallback in 'Resolve Android SDK env'." >&2
            exit 1
          fi

          # Locate sdkmanager (path differs across SDK installs).
          SDKMANAGER=""
          for CANDIDATE in \
            "$ANDROID_SDK_ROOT/cmdline-tools/latest/bin/sdkmanager" \
            "$ANDROID_SDK_ROOT/cmdline-tools/bin/sdkmanager" \
            "$(command -v sdkmanager 2>/dev/null || true)"; do
            if [ -n "$CANDIDATE" ] && [ -x "$CANDIDATE" ]; then
              SDKMANAGER="$CANDIDATE"
              break
            fi
          done
          if [ -z "$SDKMANAGER" ]; then
            echo "sdkmanager not found under ANDROID_SDK_ROOT=$ANDROID_SDK_ROOT" >&2
            find "$ANDROID_SDK_ROOT" -maxdepth 3 -type f -name sdkmanager -print || true
            exit 1
          fi

          # Accept licenses. `sdkmanager --licenses` may exit before `yes` finishes,
          # which triggers SIGPIPE and fails the step under `set -o pipefail`.
          set +o pipefail
          yes | "$SDKMANAGER" --licenses >/dev/null 2>&1 || true
          set -o pipefail
          # Install required platform/build-tools (both 35 and 36 for compatibility).
          "$SDKMANAGER" "platform-tools" "platforms;android-35" "platforms;android-36" "build-tools;35.0.0" "build-tools;36.0.0"

          echo "Installed Android platforms/build-tools (filtered):"
          "$SDKMANAGER" --list_installed | grep -E "(platforms;android-3|build-tools;3|platform-tools)" || true

      - name: Set up Flutter
        uses: subosito/flutter-action@v2
        with:
          # Use Flutter 3.27.3 which defaults to compileSdk 35 (compatible with Google Play)
          # Flutter 3.38.x defaults to SDK 36 which is not yet supported by Google Play
          flutter-version: '3.27.3'
          cache: true

      - name: Flutter version
        run: |
          flutter --version
          flutter doctor -v

      - name: Print Android compileSdk/targetSdk
        shell: bash
        run: |
          set -euo pipefail
          echo "---- android/app/build.gradle (SDK lines) ----"
          sed -n '1,140p' android/app/build.gradle | sed -n '/android {/,/defaultConfig {/{p}' || true
          grep -nE "compileSdk|targetSdk|minSdk" android/app/build.gradle || true

      - name: Install dependencies
        run: flutter pub get

      - name: Run tests
        run: flutter test

      # Gradle builds in /android require android/local.properties.
      # Flutter normally generates this during `flutter build`, but here we invoke Gradle directly
      # to capture richer stacktraces/logs, so we create it ourselves.
      - name: Generate android/local.properties (CI)
        shell: bash
        run: |
          set -euo pipefail
          FLUTTER_SDK_DIR="$(dirname "$(dirname "$(command -v flutter)")")"
          
          # Debug: Show all Android-related env vars
          echo "DEBUG: ANDROID_SDK_ROOT=${ANDROID_SDK_ROOT:-<not set>}"
          echo "DEBUG: ANDROID_HOME=${ANDROID_HOME:-<not set>}"
          
          ANDROID_SDK_DIR="${ANDROID_SDK_ROOT:-${ANDROID_HOME:-}}"
          
          # If still not set, try to find it
          if [ -z "$ANDROID_SDK_DIR" ] || [ ! -d "$ANDROID_SDK_DIR" ]; then
            echo "SDK not in env vars, searching common locations..."
            for SDK_PATH in "/usr/local/lib/android/sdk" "/opt/hostedtoolcache/android/sdk"; do
              if [ -d "$SDK_PATH" ]; then
                ANDROID_SDK_DIR="$SDK_PATH"
                echo "Found SDK at: $ANDROID_SDK_DIR"
                break
              fi
            done
          fi
          
          if [ -z "$ANDROID_SDK_DIR" ] || [ ! -d "$ANDROID_SDK_DIR" ]; then
            echo "ANDROID_SDK_ROOT/ANDROID_HOME is not set and SDK not found; cannot create sdk.dir" >&2
            echo "Listing potential SDK locations:"
            ls -la /usr/local/lib/android 2>/dev/null || echo "  /usr/local/lib/android not found"
            ls -la /opt/hostedtoolcache 2>/dev/null || echo "  /opt/hostedtoolcache not found"
            exit 1
          fi
          
          cat > android/local.properties <<EOF
          flutter.sdk=$FLUTTER_SDK_DIR
          sdk.dir=$ANDROID_SDK_DIR
          EOF
          echo "Wrote android/local.properties:" 
          cat android/local.properties

      # Always build a debug APK (no signing needed)
      - name: Build debug APK (Gradle, verbose)
        id: build_debug
        shell: bash
        run: |
          set +e
          cd android
          ./gradlew :app:assembleDebug --stacktrace --console=plain --no-daemon 2>&1 | tee ../build-debug.log
          echo "exit_code=${PIPESTATUS[0]}" >> $GITHUB_OUTPUT
          exit 0

      - name: Show Kotlin/Gradle errors (best-effort)
        if: always()
        shell: bash
        run: |
          echo "---- FAILURE section (if present) ----"
          awk '
            BEGIN {p=0}
            /FAILURE: Build failed with an exception\./ {p=1}
            p==1 {print}
            p==1 && /^BUILD FAILED/ {exit}
          ' build-debug.log || true

          echo "---- likely error lines (tail) ----"
          grep -nE "(FAILURE: Build failed|\* What went wrong:|\* Exception is:|Execution failed for task|A problem occurred|^e: |\berror:|Compilation error|Caused by:|checkDebugAarMetadata|AAR metadata|minCompileSdk|requires compileSdk|requires Android Gradle plugin|com.android.tools.build:gradle)" build-debug.log | tail -n 400 || true

          echo "---- AAR metadata issues (context) ----"
          # Print a bit of context around any AAR metadata-related failures.
          awk '
            { lines[NR]=$0 }
            /checkDebugAarMetadata|AAR metadata|minCompileSdk|requires compileSdk|requires Android Gradle plugin/ {
              start=(NR-6); if (start<1) start=1;
              end=(NR+10);
              for(i=start;i<=end;i++){ if(i in lines) print i ":" lines[i] }
              print "----";
            }
          ' build-debug.log | tail -n 500 || true

          echo "---- last 300 log lines ----"
          tail -n 300 build-debug.log || true

      - name: Upload build log (always)
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: build-debug-log
          path: build-debug.log

      - name: Fail if debug build failed
        if: steps.build_debug.outputs.exit_code != '0'
        run: exit 1

      - name: Upload debug APK artifact
        uses: actions/upload-artifact@v4
        with:
          name: app-debug-apk
          if-no-files-found: ignore
          path: |
            build/app/outputs/flutter-apk/app-debug.apk
            android/app/build/outputs/apk/debug/app-debug.apk

      # Optional: build a release APK if signing secrets are available.
      # If you want this, add these secrets in GitHub:
      # ANDROID_KEYSTORE_BASE64, ANDROID_KEYSTORE_PASSWORD, ANDROID_KEY_ALIAS, ANDROID_KEY_PASSWORD
      - name: Decode keystore (optional)
        if: env.ANDROID_KEYSTORE_BASE64 != ''
        run: |
          printf '%s' "$ANDROID_KEYSTORE_BASE64" | base64 --decode > android/app/release.keystore

      - name: Print release keystore fingerprints (SHA-1/SHA-256)
        if: env.ANDROID_KEYSTORE_BASE64 != ''
        shell: bash
        run: |
          set -euo pipefail
          echo "---- Release keystore fingerprints ----"
          # This prints only certificate fingerprints (safe to share). Required for Google Sign-In.
          keytool -list -v \
            -keystore android/app/release.keystore \
            -storepass "$ANDROID_KEYSTORE_PASSWORD" \
            | grep -E "SHA1:|SHA-1:|SHA256:|SHA-256:" || true
          echo "--------------------------------------"

      - name: Create key.properties (optional)
        if: env.ANDROID_KEYSTORE_BASE64 != ''
        shell: bash
        run: |
          printf "storePassword=%s\nkeyPassword=%s\nkeyAlias=%s\nstoreFile=release.keystore\n" \
            "$ANDROID_KEYSTORE_PASSWORD" \
            "$ANDROID_KEY_PASSWORD" \
            "$ANDROID_KEY_ALIAS" \
            > android/key.properties

      - name: Build release APK (optional)
        if: env.ANDROID_KEYSTORE_BASE64 != ''
        run: flutter build apk --release --obfuscate --split-debug-info=build/symbols

      - name: Upload release APK artifact (optional)
        if: env.ANDROID_KEYSTORE_BASE64 != ''
        uses: actions/upload-artifact@v4
        with:
          name: app-release-apk
          path: build/app/outputs/flutter-apk/app-release.apk

      # Play Store prefers Android App Bundles (AAB)
      - name: Build release AAB (optional)
        if: env.ANDROID_KEYSTORE_BASE64 != ''
        run: flutter build appbundle --release --obfuscate --split-debug-info=build/symbols

      - name: Upload release AAB artifact (optional)
        if: env.ANDROID_KEYSTORE_BASE64 != ''
        uses: actions/upload-artifact@v4
        with:
          name: app-release-aab
          path: build/app/outputs/bundle/release/app-release.aab

      # Upload mapping.txt for Play Console (ReTrace/R8 deobfuscation)
      - name: Upload mapping.txt artifact
        if: env.ANDROID_KEYSTORE_BASE64 != ''
        uses: actions/upload-artifact@v4
        with:
          name: mapping-txt
          if-no-files-found: ignore
          path: android/app/build/outputs/mapping/release/mapping.txt

      # Upload native debug symbols for Play Console (Android .so files by ABI)
      - name: Package native debug symbols
        if: env.ANDROID_KEYSTORE_BASE64 != ''
        shell: bash
        run: |
          # Find the native libs directory (contains arm64-v8a, armeabi-v7a, x86_64 folders)
          NATIVE_LIBS_DIR=""
          for DIR in \
            "android/app/build/intermediates/merged_native_libs/release/out/lib" \
            "android/app/build/intermediates/stripped_native_libs/release/out/lib" \
            "build/app/intermediates/merged_native_libs/release/out/lib"; do
            if [ -d "$DIR" ]; then
              NATIVE_LIBS_DIR="$DIR"
              break
            fi
          done
          
          if [ -n "$NATIVE_LIBS_DIR" ] && [ -d "$NATIVE_LIBS_DIR" ]; then
            echo "Found native libs at: $NATIVE_LIBS_DIR"
            ls -la "$NATIVE_LIBS_DIR"
            cd "$NATIVE_LIBS_DIR"
            zip -r "$GITHUB_WORKSPACE/native-debug-symbols.zip" .
            echo "Created native-debug-symbols.zip"
          else
            echo "Native libs directory not found, checking available paths..."
            find android/app/build -name "*.so" -type f 2>/dev/null | head -20 || true
          fi
      
      - name: Upload native debug symbols artifact
        if: env.ANDROID_KEYSTORE_BASE64 != ''
        uses: actions/upload-artifact@v4
        with:
          name: native-debug-symbols
          if-no-files-found: ignore
          path: native-debug-symbols.zip

      # Upload Dart debug symbols (for Flutter crash symbolication)
      - name: Package Dart debug symbols
        if: env.ANDROID_KEYSTORE_BASE64 != ''
        shell: bash
        run: |
          if [ -d "build/symbols" ]; then
            cd build && zip -r dart-debug-symbols.zip symbols
          fi
      
      - name: Upload Dart debug symbols artifact
        if: env.ANDROID_KEYSTORE_BASE64 != ''
        uses: actions/upload-artifact@v4
        with:
          name: dart-debug-symbols
          if-no-files-found: ignore
          path: build/dart-debug-symbols.zip
