# yaml-language-server: $schema=https://json.schemastore.org/github-workflow.json

name: Android APK (Flutter)

on:
  push:
    branches: ["main"]
  pull_request:
    branches: ["main"]
  workflow_dispatch:

jobs:
  build-apk:
    runs-on: ubuntu-latest

    env:
      ANDROID_KEYSTORE_BASE64: ${{ secrets.ANDROID_KEYSTORE_BASE64 }}
      ANDROID_KEYSTORE_PASSWORD: ${{ secrets.ANDROID_KEYSTORE_PASSWORD }}
      ANDROID_KEY_PASSWORD: ${{ secrets.ANDROID_KEY_PASSWORD }}
      ANDROID_KEY_ALIAS: ${{ secrets.ANDROID_KEY_ALIAS }}

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Prepare Gradle wrapper (LF + executable)
        shell: bash
        run: |
          set -euo pipefail
          # In case gradlew was committed with CRLF or lost its +x bit.
          sed -i 's/\r$//' android/gradlew
          chmod +x android/gradlew

      - name: Set up Java
        uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: "17"

      - name: Resolve Android SDK env
        shell: bash
        run: |
          set -euo pipefail
          # Prefer runner-provided values. If not set (or invalid), probe common SDK locations.
          SDK_ROOT=""
          if [ -n "${ANDROID_SDK_ROOT:-}" ] && [ -d "${ANDROID_SDK_ROOT}" ]; then
            SDK_ROOT="$ANDROID_SDK_ROOT"
          elif [ -n "${ANDROID_HOME:-}" ] && [ -d "${ANDROID_HOME}" ]; then
            SDK_ROOT="$ANDROID_HOME"
          else
            for CANDIDATE in \
              "/usr/local/lib/android/sdk" \
              "/opt/hostedtoolcache/android/sdk" \
              "/opt/android-sdk" \
              "/opt/android"; do
              if [ -d "$CANDIDATE" ]; then
                SDK_ROOT="$CANDIDATE"
                break
              fi
            done
          fi

          if [ -z "$SDK_ROOT" ]; then
            echo "Android SDK not found. Checked ANDROID_SDK_ROOT/ANDROID_HOME and common locations." >&2
            echo "ANDROID_SDK_ROOT=${ANDROID_SDK_ROOT:-<unset>}" >&2
            echo "ANDROID_HOME=${ANDROID_HOME:-<unset>}" >&2
            echo "Directory listing of /usr/local/lib/android (if present):" >&2
            ls -la /usr/local/lib/android 2>/dev/null || true
            echo "Directory listing of /opt/hostedtoolcache/android (if present):" >&2
            ls -la /opt/hostedtoolcache/android 2>/dev/null || true
            exit 1
          fi

          echo "ANDROID_SDK_ROOT=$SDK_ROOT" >> "$GITHUB_ENV"
          echo "ANDROID_HOME=$SDK_ROOT" >> "$GITHUB_ENV"
          echo "Resolved ANDROID_SDK_ROOT=$SDK_ROOT"

      - name: Ensure Android SDK platform (API 36)
        shell: bash
        run: |
          set -euo pipefail
          echo "ANDROID_SDK_ROOT=$ANDROID_SDK_ROOT"
          echo "ANDROID_HOME=$ANDROID_HOME"

          if [ ! -d "$ANDROID_SDK_ROOT" ]; then
            echo "ANDROID_SDK_ROOT does not exist at $ANDROID_SDK_ROOT" >&2
            echo "If GitHub runner changes, update the fallback in 'Resolve Android SDK env'." >&2
            exit 1
          fi

          # Locate sdkmanager (path differs across SDK installs).
          SDKMANAGER=""
          for CANDIDATE in \
            "$ANDROID_SDK_ROOT/cmdline-tools/latest/bin/sdkmanager" \
            "$ANDROID_SDK_ROOT/cmdline-tools/bin/sdkmanager" \
            "$(command -v sdkmanager 2>/dev/null || true)"; do
            if [ -n "$CANDIDATE" ] && [ -x "$CANDIDATE" ]; then
              SDKMANAGER="$CANDIDATE"
              break
            fi
          done
          if [ -z "$SDKMANAGER" ]; then
            echo "sdkmanager not found under ANDROID_SDK_ROOT=$ANDROID_SDK_ROOT" >&2
            find "$ANDROID_SDK_ROOT" -maxdepth 3 -type f -name sdkmanager -print || true
            exit 1
          fi

          # Accept licenses. `sdkmanager --licenses` may exit before `yes` finishes,
          # which triggers SIGPIPE and fails the step under `set -o pipefail`.
          set +o pipefail
          yes | "$SDKMANAGER" --licenses >/dev/null 2>&1 || true
          set -o pipefail
          # Install required platform. If build-tools 36 isn't available, fall back to 35.
          "$SDKMANAGER" "platform-tools" "platforms;android-36"
          if ! "$SDKMANAGER" "build-tools;36.0.0"; then
            "$SDKMANAGER" "build-tools;35.0.0"
          fi

          echo "Installed Android platforms/build-tools (filtered):"
          "$SDKMANAGER" --list_installed | grep -E "(platforms;android-36|build-tools;3[5-6]\\.|platform-tools)" || true

      - name: Set up Flutter
        uses: subosito/flutter-action@v2
        with:
          channel: "stable"
          cache: true

      - name: Flutter version
        run: |
          flutter --version
          flutter doctor -v

      - name: Print Android compileSdk/targetSdk
        shell: bash
        run: |
          set -euo pipefail
          echo "---- android/app/build.gradle (SDK lines) ----"
          sed -n '1,140p' android/app/build.gradle | sed -n '/android {/,/defaultConfig {/{p}' || true
          grep -nE "compileSdk|targetSdk|minSdk" android/app/build.gradle || true

      - name: Install dependencies
        run: flutter pub get

      - name: Run tests
        run: flutter test

      # Gradle builds in /android require android/local.properties.
      # Flutter normally generates this during `flutter build`, but here we invoke Gradle directly
      # to capture richer stacktraces/logs, so we create it ourselves.
      - name: Generate android/local.properties (CI)
        shell: bash
        run: |
          set -euo pipefail
          FLUTTER_SDK_DIR="$(dirname "$(dirname "$(command -v flutter)")")"
          ANDROID_SDK_DIR="${ANDROID_SDK_ROOT:-${ANDROID_HOME:-}}"
          if [ -z "$ANDROID_SDK_DIR" ]; then
            echo "ANDROID_SDK_ROOT/ANDROID_HOME is not set; cannot create sdk.dir" >&2
            exit 1
          fi
          cat > android/local.properties <<EOF
          flutter.sdk=$FLUTTER_SDK_DIR
          sdk.dir=$ANDROID_SDK_DIR
          EOF
          echo "Wrote android/local.properties:" 
          cat android/local.properties

      # Always build a debug APK (no signing needed)
      - name: Build debug APK (Gradle, verbose)
        id: build_debug
        shell: bash
        run: |
          set +e
          cd android
          ./gradlew :app:assembleDebug --stacktrace --console=plain --no-daemon 2>&1 | tee ../build-debug.log
          echo "exit_code=${PIPESTATUS[0]}" >> $GITHUB_OUTPUT
          exit 0

      - name: Show Kotlin/Gradle errors (best-effort)
        if: always()
        shell: bash
        run: |
          echo "---- FAILURE section (if present) ----"
          awk '
            BEGIN {p=0}
            /FAILURE: Build failed with an exception\./ {p=1}
            p==1 {print}
            p==1 && /^BUILD FAILED/ {exit}
          ' build-debug.log || true

          echo "---- likely error lines (tail) ----"
          grep -nE "(FAILURE: Build failed|\* What went wrong:|\* Exception is:|Execution failed for task|A problem occurred|^e: |\berror:|Compilation error|Caused by:)" build-debug.log | tail -n 250 || true

          echo "---- last 300 log lines ----"
          tail -n 300 build-debug.log || true

      - name: Upload build log (always)
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: build-debug-log
          path: build-debug.log

      - name: Fail if debug build failed
        if: steps.build_debug.outputs.exit_code != '0'
        run: exit 1

      - name: Upload debug APK artifact
        uses: actions/upload-artifact@v4
        with:
          name: app-debug-apk
          if-no-files-found: ignore
          path: |
            build/app/outputs/flutter-apk/app-debug.apk
            android/app/build/outputs/apk/debug/app-debug.apk

      # Optional: build a release APK if signing secrets are available.
      # If you want this, add these secrets in GitHub:
      # ANDROID_KEYSTORE_BASE64, ANDROID_KEYSTORE_PASSWORD, ANDROID_KEY_ALIAS, ANDROID_KEY_PASSWORD
      - name: Decode keystore (optional)
        if: env.ANDROID_KEYSTORE_BASE64 != ''
        run: |
          printf '%s' "$ANDROID_KEYSTORE_BASE64" | base64 --decode > android/app/release.keystore

      - name: Create key.properties (optional)
        if: env.ANDROID_KEYSTORE_BASE64 != ''
        shell: bash
        run: |
          printf "storePassword=%s\nkeyPassword=%s\nkeyAlias=%s\nstoreFile=release.keystore\n" \
            "$ANDROID_KEYSTORE_PASSWORD" \
            "$ANDROID_KEY_PASSWORD" \
            "$ANDROID_KEY_ALIAS" \
            > android/key.properties

      - name: Build release APK (optional)
        if: env.ANDROID_KEYSTORE_BASE64 != ''
        run: flutter build apk --release

      - name: Upload release APK artifact (optional)
        if: env.ANDROID_KEYSTORE_BASE64 != ''
        uses: actions/upload-artifact@v4
        with:
          name: app-release-apk
          path: build/app/outputs/flutter-apk/app-release.apk

      # Play Store prefers Android App Bundles (AAB)
      - name: Build release AAB (optional)
        if: env.ANDROID_KEYSTORE_BASE64 != ''
        run: flutter build appbundle --release

      - name: Upload release AAB artifact (optional)
        if: env.ANDROID_KEYSTORE_BASE64 != ''
        uses: actions/upload-artifact@v4
        with:
          name: app-release-aab
          path: build/app/outputs/bundle/release/app-release.aab
